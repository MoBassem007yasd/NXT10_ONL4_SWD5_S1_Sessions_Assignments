DROP TABLE IF EXISTS Employee_Project;
DROP TABLE IF EXISTS Dependents;
DROP TABLE IF EXISTS Project;
IF OBJECT_ID('dbo.Employee', 'U') IS NOT NULL ALTER TABLE Employee DROP CONSTRAINT IF EXISTS FK_Employee_Department;
IF OBJECT_ID('dbo.Department', 'U') IS NOT NULL ALTER TABLE Department DROP CONSTRAINT IF EXISTS FK_Department_Manager;
DROP TABLE IF EXISTS Employee;
DROP TABLE IF EXISTS Department;
GO

CREATE TABLE Department (
    Dnum INT PRIMARY KEY,
    Dname NVARCHAR(50) NOT NULL UNIQUE,
    Location NVARCHAR(100),
    ESSN INT, 
    Hire_date DATE NOT NULL DEFAULT GETDATE()
);

CREATE TABLE Employee (
    SSN INT PRIMARY KEY,
    Fname NVARCHAR(50) NOT NULL,
    Lname NVARCHAR(50) NOT NULL,
    Birthdate DATE NOT NULL,
    Gender CHAR(1) CONSTRAINT CK_Gender CHECK (Gender IN ('M', 'F')),
    Dnum INT NOT NULL, 
    SuperViser INT,
    Salary DECIMAL(10, 2) DEFAULT 3000.00
);

CREATE TABLE Project (
    Pnum INT PRIMARY KEY,
    PName NVARCHAR(100) NOT NULL,
    City NVARCHAR(50) NOT NULL,
    DNUM INT NOT NULL
);

CREATE TABLE Dependents (
    Dependent_Name NVARCHAR(50),
    SSN INT,
    Birthdate DATE NOT NULL,
    Gender CHAR(1) CHECK (Gender IN ('M', 'F')),
    PRIMARY KEY (Dependent_Name, SSN)
);

CREATE TABLE Employee_Project (
    SSN INT,
    Pnum INT,
    Working_hours DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    PRIMARY KEY (SSN, Pnum)
);
GO

ALTER TABLE Employee
ADD CONSTRAINT FK_Employee_Department FOREIGN KEY (Dnum)
REFERENCES Department(Dnum)
ON UPDATE CASCADE
ON DELETE NO ACTION;

ALTER TABLE Employee
ADD CONSTRAINT FK_Employee_Supervisor FOREIGN KEY (SuperViser)
REFERENCES Employee(SSN)
ON UPDATE NO ACTION
ON DELETE NO ACTION;

ALTER TABLE Project
ADD CONSTRAINT FK_Project_Department FOREIGN KEY (DNUM)
REFERENCES Department(Dnum)
ON UPDATE CASCADE
ON DELETE CASCADE;

ALTER TABLE Dependents
ADD CONSTRAINT FK_Dependents_Employee FOREIGN KEY (SSN)
REFERENCES Employee(SSN)
ON UPDATE CASCADE
ON DELETE CASCADE;

ALTER TABLE Employee_Project
ADD CONSTRAINT FK_WorksOn_Employee FOREIGN KEY (SSN)
REFERENCES Employee(SSN)
ON UPDATE NO ACTION 
ON DELETE NO ACTION;

ALTER TABLE Employee_Project
ADD CONSTRAINT FK_WorksOn_Project FOREIGN KEY (Pnum)
REFERENCES Project(Pnum)
ON UPDATE CASCADE
ON DELETE CASCADE;

ALTER TABLE Employee ADD Phone_Number VARCHAR(15);

ALTER TABLE Department 
ADD CONSTRAINT FK_Department_Manager FOREIGN KEY (ESSN) 
REFERENCES Employee(SSN)
ON UPDATE CASCADE
ON DELETE SET NULL;

ALTER TABLE Project ALTER COLUMN City NVARCHAR(150) NOT NULL;

ALTER TABLE Employee DROP CONSTRAINT CK_Gender;
GO

INSERT INTO Department (Dnum, Dname, Location, ESSN, Hire_date) VALUES 
(10, 'Software Engineering', 'Cairo', NULL, '2020-01-01'),
(20, 'HR', 'Alexandria', NULL, '2019-05-15'),
(30, 'Sales', 'Giza', NULL, '2021-03-10');

INSERT INTO Employee (SSN, Fname, Lname, Birthdate, Gender, Dnum, SuperViser, Salary) VALUES 
(101, 'Ahmed', 'Ali', '1990-05-10', 'M', 10, NULL, 5000),
(102, 'Sara', 'Hassan', '1995-08-22', 'F', 10, 101, 4000),      
(103, 'Mona', 'Said', '1988-12-01', 'F', 20, NULL, 6000),
(104, 'Omar', 'Khaled', '1992-07-14', 'M', 30, NULL, 5500),
(105, 'Kareem', 'Essam', '1998-11-30', 'M', 10, 101, 3000);     

UPDATE Department SET ESSN = 101 WHERE Dnum = 10;
UPDATE Department SET ESSN = 103 WHERE Dnum = 20;
UPDATE Department SET ESSN = 104 WHERE Dnum = 30;

INSERT INTO Project (Pnum, PName, City, DNUM) VALUES 
(500, 'Website Redesign', 'Cairo', 10),
(600, 'Employee Portal', 'Alexandria', 20),
(700, 'Marketing Campaign', 'Giza', 30);

INSERT INTO Dependents (Dependent_Name, SSN, Birthdate, Gender) VALUES 
('Zena', 101, '2015-02-10', 'F'),
('Youssef', 103, '2018-06-20', 'M');

INSERT INTO Employee_Project (SSN, Pnum, Working_hours) VALUES 
(101, 500, 20.5),
(102, 500, 40.0),
(105, 500, 35.0),
(103, 600, 15.0),
(104, 700, 10.0);
GO
